<!--
 * @Date: 2024-12-28
 * @LastEditors: cuijianzhuang
 * @Description: 
-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <title>离线照片水印打码工具</title>
    <style>
        #container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        #graph {
            display: grid;
            grid-gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            margin-top: 20px;
        }

        h1 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 28px;
        }

        article {
            font-size: 15px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        article a {
            color: #3498db;
            text-decoration: none;
        }

        article a:hover {
            text-decoration: underline;
        }

        .align-center-box {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        label {
            color: #2c3e50;
            font-size: 16px;
            margin-right: 15px;
            font-weight: 500;
        }

        input[type="file"] {
            padding: 8px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        input#text {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }

        input[type=range] {
            width: 200px;
            height: 6px;
            border-radius: 3px;
        }

        canvas {
            width: 100%;
            border: 2px dashed #ddd;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        canvas:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-left: 10px;
        }

        button:hover {
            background: #2980b9;
        }

        .image-container {
            position: relative;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .image-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .image-container canvas {
            width: 100%;
            height: auto;
            display: block;
            margin: 0;
            border: 1px solid #eee;
        }

        .image-info {
            padding: 10px 0 0;
            font-size: 13px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: #2980b9;
        }

        .image-container canvas {
            cursor: zoom-in;
            transition: transform 0.2s;
        }
        
        .image-container canvas:hover {
            transform: scale(1.02);
        }
        
        #previewModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            transform: translateZ(0);
            will-change: transform;
        }
        
        #previewImage {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            cursor: zoom-out;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            border-radius: 4px;
            transform: scale(0.95) translateZ(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            backface-visibility: hidden;
        }
        
        #previewModal.active #previewImage {
            transform: scale(1) translateZ(0);
        }
    </style>
</head>
<div id="container">
    <h1>离线照片水印打码工具</h1>
    <article>安全地为你的图片加水印，无任何网络请求，利用浏览器api实现水印，特别适合各种敏感证件（身份证，驾照，护照等）。<a
            href="https://github.com/cuijianzhuang/photo-watermark">Github地址，求 star</a></article>

    <div class="align-center-box">
        <label for="image">第一步：先选择本地图片(可多选)</label>
        <input type="file" id="image" autocomplete="off" multiple>
    </div>
    <div class="align-center-box">
        <label for="text">第二步：输入需要打水印的文字</label>
        <input style="flex:1;margin-bottom:0" type="text" id="text" placeholder="请输入文字" autocomplete="off">
    </div>

    <p class="align-center-box">

        <label for="color">颜色</label>
        <input style="flex:1;margin-right:30px" type="color" id="color" pattern="#[0-9A-Fa-f]{6}" autocomplete="off"
            value="#ffffff"><br>

        <label for="alpha">透明度</label>
        <input style="flex:1;margin-right:30px" type="range" id="alpha" min="0" max="1" step="0.05" autocomplete="off"
            value="0.3"><br>

        <label for="space">间隔</label>
        <input style="flex:1;margin-right:30px" type="range" id="space" min="1" max="8" step="0.2" autocomplete="off"
            value="1.5"><br>

        <label for="size">字号</label>
        <input style="flex:1;margin-right:30px" type="range" id="size" min="0.5" max="3" step="0.05" autocomplete="off"
            value="0.8">

        <label for="rotate">旋转角度</label>
        <input style="flex:1;margin-right:30px" type="range" id="rotate" min="0" max="360" step="5" autocomplete="off" value="45"><br>
    </p>

    <label for="text">第三步：点击图片进行单个图片下载</label>
    <button onclick="downloadAllPic()">下载全部</button>
    <p id="graph"></p>
    <footer style="text-align: center; margin-top: 30px; padding: 20px 0; color: #666; font-size: 14px; border-top: 1px solid #eee;">
        <p>© 2024 离线照片水印打码工具 | 作者：<a href="https://github.com/cuijianzhuang" style="color: #3498db; text-decoration: none;">cuijianzhuang</a></p>
        <p style="margin-top: 5px; font-size: 13px;">本工具完全离线运行，保护您的隐私安全</p>
    </footer>
</div>
<div id="previewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
    <img id="previewImage" style="max-width:90%; max-height:90%; object-fit:contain; cursor:zoom-out;">
</div>
<script>
    var $, canvas, dataURItoBlob, graph, image, configInputSetting, inputItems,
        readFile, previewModal, previewImage;

    $ = function (sel) {
        return document.querySelector(sel);
    };

    inputItems = ['text', 'color', 'alpha', 'space', 'size', 'rotate'];

    configInputSetting = {}; // 保存所有水印
    allCanvas = []; // 保存所有的canvas

    image = $('#image');

    graph = $('#graph');

    dataURItoBlob = function (dataURI) {
        var arr, binStr, i, len, _i, _ref;
        binStr = atob((dataURI.split(','))[1]);
        len = binStr.length;
        arr = new Uint8Array(len);
        for (i = _i = 0, _ref = len - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
            arr[i] = binStr.charCodeAt(i);
        }
        return new Blob([arr], {
            type: 'image/png'
        });
    };

    const generateFileName = (fileName) => {
        var d, pad;
        pad = function (n) {
            if (n < 10) {
                return '0' + n;
            } else {
                return n;
            }
        };
        d = new Date;
        const timeStr = '' + d.getFullYear() + '-' + (pad(d.getMonth() + 1)) + '-' + (pad(d.getDate())) + ' ' + (
            pad(d
                .getHours())) + (pad(d.getMinutes())) + (pad(d.getSeconds()))
        return fileName + '_' + timeStr + '.png';
    };
    const redrawCanvas = (canvas, img) => {
        // 重新设置canvas的宽高，会清空画布
        var w = canvas.width;
        var h = canvas.height;
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0);
    };

    const downloadCanvasAsImage = (canvas, fileName) => {
        var blob, imageData, link;
        link = document.createElement('a');
        link.download = generateFileName(fileName);
        imageData = canvas.toDataURL('image/png');
        blob = dataURItoBlob(imageData);
        link.href = URL.createObjectURL(blob);
        graph.appendChild(link);
        return setTimeout(function () {
            link.click();
            return graph.removeChild(link);
        }, 10);
    }
    const downloadAllPic = async () => {
        if (allCanvas.length === 0) {
            return alert('请先添加图片');
        }
        allCanvas.forEach(({canvas, fileName}) => {
            setTimeout(() => {
                downloadCanvasAsImage(canvas, fileName);
            }, 100); // 添加少许延迟，避免浏览器同时触发太多下载
        });
    };
    readFile = function (file) {
        var fileReader;
        if (file == null) {
            return;
        }
        
        // const MAX_SIZE = 5 * 1024 * 1024; // 5MB
        // if(file.size > MAX_SIZE) {
        //     return alert('图片大小不能超过5MB');
        // }
        //
        fileReader = new FileReader;
        fileReader.onerror = function() {
            alert('图片读取失败');
        };
        
        fileReader.onload = function () {
            var img;
            img = new Image;
            img.onload = function () {
                var ctx;
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                allCanvas.push({
                    img: img,
                    canvas: canvas,
                    fileName: file.name
                });

                drawText(canvas, img);
                
                // 创建图片容器
                const container = document.createElement('div');
                container.className = 'image-container';
                
                // 添加画布，并增加点击预览功能
                canvas.style.cursor = 'zoom-in';
                canvas.addEventListener('click', () => {
                    // 预先生成图片数据
                    const imageData = canvas.toDataURL('image/png');
                    
                    // 预加载图片
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        previewImage.src = imageData;
                        previewModal.style.display = 'flex';
                        // 强制回流
                        previewModal.offsetHeight;
                        previewModal.classList.add('active');
                    };
                    tempImg.src = imageData;
                });
                container.appendChild(canvas);
                
                // 添加图片信息和下载按钮
                const infoDiv = document.createElement('div');
                infoDiv.className = 'image-info';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = file.name;
                infoDiv.appendChild(nameSpan);
                
                const sizeSpan = document.createElement('span');
                sizeSpan.textContent = `${(file.size / 1024).toFixed(1)}KB`;
                infoDiv.appendChild(sizeSpan);
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = '下载';
                downloadBtn.onclick = () => downloadCanvasAsImage(canvas, file.name);
                infoDiv.appendChild(downloadBtn);
                
                container.appendChild(infoDiv);
                
                // 添加到网格中
                graph.appendChild(container);
                
                // 移除原来的点击事件
                // canvas.addEventListener('click', () => downloadCanvasAsImage(canvas, file.name));
            };
            return img.src = fileReader.result;
        };
        return fileReader.readAsDataURL(file);
    };

    const makeStyle = () => {
        var match;
        match = configInputSetting.color.value.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
        return 'rgba(' + (parseInt(match[1], 16)) + ',' + (parseInt(match[2], 16)) + ',' + (parseInt(match[3],
            16)) + ',' + configInputSetting.alpha.value + ')';
    };

    const drawText = (canvas, img) => {
        redrawCanvas(canvas, img);
        var textCtx = canvas.getContext('2d');
        if (canvas == null) {
            return;
        }

        // 保存当前状态
        textCtx.save();
        
        // 移动坐标原点到画布中心
        textCtx.translate(canvas.width/2, canvas.height/2);
        
        // 在中心点进行旋转
        textCtx.rotate(configInputSetting.rotate.value * Math.PI / 180);
        
        // 计算旋转后需要覆盖的矩形范围
        const diagonal = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);
        const textSize = configInputSetting.size.value * Math.max(15, diagonal / 25);
        
        textCtx.fillStyle = makeStyle();
        textCtx.font = 'bold ' + textSize +
            'px -apple-system,"Helvetica Neue",Helvetica,Arial,"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei",sans-serif';
        
        const width = textCtx.measureText(configInputSetting.text.value).width;
        const margin = textCtx.measureText('啊').width;
        
        // 计算需要绘制的范围
        const rectWidth = diagonal;
        const rectHeight = diagonal;
        
        // 计算起始位置，使字从左上角开始填充
        const startX = -rectWidth/2;
        const startY = -rectHeight/2;
        
        // 计算水印间距
        const xStep = width + margin;
        const yStep = configInputSetting.space.value * textSize;
        
        // 计算需要重复的次数
        const cols = Math.ceil(rectWidth / xStep);
        const rows = Math.ceil(rectHeight / yStep);
        
        // 制水印
        for (let i = 0; i <= cols; i++) {
            for (let j = 0; j <= rows; j++) {
                const x = startX + i * xStep;
                const y = startY + j * yStep;
                textCtx.fillText(configInputSetting.text.value, x, y);
            }
        }
        
        // 恢复画布状态
        textCtx.restore();
    };

    image.addEventListener('change', function () {
        // 处理批量图片
        const batchFileHandler = function (file) {
            const type = file.type;
            if (!['image/png', 'image/jpeg', 'image/gif'].includes(type)) {
                return alert('仅支持 png, jpg, gif 图片格式');
            }
            readFile(file);
        };
        [...this.files].forEach(batchFileHandler);
    });

    inputItems.forEach(function (item) {
        var el;
        el = $('#' + item);
        configInputSetting[item] = el;
        return el.addEventListener('input', () => {
            allCanvas.forEach(({
                canvas,
                img
            }) => {
                drawText(canvas, img);
            });
        });
    });

    const container = $('#container');

    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        container.style.border = '2px dashed #3498db';
    });

    container.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        container.style.border = 'none';
    });

    container.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        container.style.border = 'none';
        
        const files = [...e.dataTransfer.files];
        files.forEach(file => {
            const type = file.type;
            if (!['image/png', 'image/jpeg', 'image/gif'].includes(type)) {
                return alert('仅支持 png, jpg, gif 图片格式');
            }
            readFile(file);
        });
    });

    previewModal = $('#previewModal');
    previewImage = $('#previewImage');
    
    previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) {  // 只有点击背景才关闭
            previewModal.classList.remove('active');
            setTimeout(() => {
                previewModal.style.display = 'none';
                // 清理资源
                previewImage.src = '';
            }, 200);
        }
    });

    // 阻止图片点击事件冒泡
    previewImage.addEventListener('click', (e) => {
        e.stopPropagation();
    });
</script>

</html>